# =============================================================================
# Simple Enigma Agent Test Container
# =============================================================================
# Lightweight container for basic network traffic capture testing
# without the full Enigma agent - useful for quick validation tests

FROM debian:bullseye-slim

# -----------------------------------------------------------------------------
# Package Installation
# -----------------------------------------------------------------------------
# Install essential packages for network capture and load testing
RUN apt-get update && apt-get install -y \
    # Network capture tools
    tcpdump \
    # HTTP client and utilities
    curl \
    wget \
    # Load testing tools
    apache2-utils \
    # Network utilities
    dnsutils \
    iputils-ping \
    net-tools \
    # System utilities
    procps \
    # Python runtime
    python3 \
    python3-minimal \
    && rm -rf /var/lib/apt/lists/*

# -----------------------------------------------------------------------------
# Directory Structure
# -----------------------------------------------------------------------------
RUN mkdir -p \
    /app/captures \
    /app/logs

# -----------------------------------------------------------------------------
# Load Testing Scripts
# -----------------------------------------------------------------------------
# Copy and prepare load testing scripts
COPY load-test.sh /app/load-test.sh
COPY heavy-load-test.sh /app/heavy-load-test.sh
RUN chmod +x \
    /app/load-test.sh \
    /app/heavy-load-test.sh

# -----------------------------------------------------------------------------
# Test Capture Script
# -----------------------------------------------------------------------------
# Create simple test script for traffic capture validation
RUN cat > /app/test-capture.sh << 'EOF'
#!/bin/bash

echo "Starting network traffic capture test..."

# Start network capture in background
echo "Starting tcpdump in background..."
tcpdump -i any -w /app/captures/capture-$(date +%s).pcap &
TCPDUMP_PID=$!
echo "tcpdump started with PID $TCPDUMP_PID"

# Start load test to generate traffic
echo "Starting load test..."
./load-test.sh &
LOAD_TEST_PID=$!
echo "Load test started with PID $LOAD_TEST_PID"

# Capture traffic for specified duration
echo "Capturing traffic for 60 seconds..."
sleep 60

# Stop capture process
echo "Stopping tcpdump..."
kill $TCPDUMP_PID

# Display results
echo "Checking captured files..."
ls -la /app/captures/

echo "Traffic capture test completed!"

# Keep container alive for inspection
sleep 300
EOF

RUN chmod +x /app/test-capture.sh

# -----------------------------------------------------------------------------
# Container Configuration
# -----------------------------------------------------------------------------
WORKDIR /app

# Default command runs the traffic capture test
CMD ["./test-capture.sh"]